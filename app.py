import streamlit as st

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(page_title="å…¨èƒ½å·¥ç¨‹æŸ¥è¯¢åŠ©æ‰‹", page_icon="ğŸ› ï¸", layout="wide")

st.title("ğŸ› ï¸ å…¨èƒ½å·¥ç¨‹æŸ¥è¯¢åŠ©æ‰‹")
st.markdown("é›†æˆï¼š**ISO 286 å…¬å·®** | **å…¬åˆ¶é”®æ§½ (Metric)** | **è‹±åˆ¶é”®æ§½ (Imperial)** | **å•ä½è½¬æ¢**")

# åˆ›å»º 4 ä¸ªé€‰é¡¹å¡
tab1, tab2, tab3, tab4 = st.tabs([
    "ğŸ“ ISO 286 å…¬å·®", 
    "ğŸ—ï¸ å…¬åˆ¶é”®æ§½ (mm)", 
    "ğŸ‡ºğŸ‡¸ è‹±åˆ¶é”®æ§½ (inch)", 
    "ğŸ”„ é”®æ§½å•ä½è½¬æ¢"
])

# ==============================================================================
# TAB 1: ISO 286 å…¬å·®æŸ¥è¯¢
# ==============================================================================
with tab1:
    st.header("ISO 286 å…¬å·®æŸ¥è¯¢")
    st.caption("æ•°æ®æºï¼šISO 286-1 æ ‡å‡† (0-3150mm)")

    # ISO 286 æ•°æ®
    RANGES_ISO = [3, 6, 10, 18, 30, 50, 80, 120, 180, 250, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3150]
    DATA_TABLE_ISO = {
        "H7": [0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063, 0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210],
        "H8": [0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097, 0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330],
        "F7": [(0.016, 0.006), (0.022, 0.010), (0.028, 0.013), (0.034, 0.016), (0.041, 0.020), (0.050, 0.025), (0.060, 0.030), (0.071, 0.036), (0.083, 0.043), (0.096, 0.050), (0.108, 0.056), (0.119, 0.062), (0.131, 0.068), (0.150, 0.080), (0.170, 0.090), (0.190, 0.100), (0.220, 0.115), (0.260, 0.135), (0.310, 0.160), (0.365, 0.190), (0.440, 0.230)],
        "G7": [(0.012, 0.002), (0.016, 0.004), (0.020, 0.005), (0.024, 0.006), (0.028, 0.007), (0.034, 0.009), (0.040, 0.010), (0.047, 0.012), (0.054, 0.014), (0.061, 0.015), (0.069, 0.017), (0.075, 0.018), (0.083, 0.020), (0.096, 0.026), (0.108, 0.028), (0.122, 0.032), (0.141, 0.036), (0.167, 0.042), (0.200, 0.050), (0.235, 0.060), (0.280, 0.070)],
        "K7": [(0.000, -0.010), (0.003, -0.009), (0.005, -0.010), (0.006, -0.012), (0.006, -0.015), (0.007, -0.018), (0.009, -0.021), (0.010, -0.025), (0.012, -0.028), (0.013, -0.033), (0.016, -0.036), (0.017, -0.040), (0.018, -0.045), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)],
        "h7": [0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063, 0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210],
        "h8": [0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097, 0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330],
        "h12": [0.10, 0.12, 0.15, 0.18, 0.21, 0.25, 0.30, 0.35, 0.40, 0.46, 0.52, 0.57, 0.63, 0.70, 0.80, 0.90, 1.05, 1.25, 1.50, 1.75, 2.10],
        "h14": [0.25, 0.30, 0.36, 0.43, 0.52, 0.62, 0.74, 0.87, 1.0, 1.15, 1.3, 1.4, 1.55, 1.75, 2.0, 2.3, 2.6, 3.1, 3.7, 4.4, 5.4],
        "g8": [(-0.002, -0.016), (-0.004, -0.022), (-0.005, -0.027), (-0.006, -0.033), (-0.007, -0.040), (-0.009, -0.048), (-0.010, -0.056), (-0.012, -0.066), (-0.014, -0.077), (-0.015, -0.087), (-0.017, -0.098), (-0.018, -0.107), (-0.020, -0.117), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)]
    }

    col1, col2 = st.columns([3, 1])
    with col1:
        iso_size = st.number_input("è¾“å…¥å…¬ç§°å°ºå¯¸ (mm)", 0.1, 3150.0, 1000.0, 10.0)
    with col2:
        iso_code = st.selectbox("å…¬å·®å¸¦", ["h14", "h12", "h8", "h7", "g8", "H7", "H8", "F7", "G7", "K7"])

    if st.button("æŸ¥è¯¢ ISO", type="primary"):
        # ç®€å•æŸ¥è¡¨é€»è¾‘
        idx = -1
        prev = 0
        for i, r in enumerate(RANGES_ISO):
            if iso_size <= r:
                idx = i; break
            prev = r
        
        if idx != -1 and iso_code in DATA_TABLE_ISO:
            val = DATA_TABLE_ISO[iso_code][idx]
            if isinstance(val, tuple): u, l = val
            elif iso_code[0] == 'H': u, l = val, 0
            else: u, l = 0, -val
            
            st.success(f"âœ… {iso_code} (Ã˜{iso_size}mm)")
            c1, c2, c3 = st.columns(3)
            c1.metric("Max", f"{iso_size+u:.3f}")
            c2.metric("Min", f"{iso_size+l:.3f}")
            c3.metric("IT", f"{(u-l)*1000:.0f} Î¼m" if (u-l)<1 else f"{(u-l):.2f} mm")
            st.info(f"åå·®: {u*1000:+.0f}/{l*1000:+.0f} Î¼m" if abs(u)<1 else f"{u:+.3f}/{l:+.3f} mm")
        else:
            st.error("æœªæ‰¾åˆ°æ•°æ®æˆ–å°ºå¯¸è¶…å‡ºèŒƒå›´")

# ==============================================================================
# TAB 2: å…¬åˆ¶é”®æ§½ (BS 4235 / ISO)
# ==============================================================================
with tab2:
    st.header("å…¬åˆ¶é”®æ§½ (Metric Keyway)")
    st.caption("è¾“å…¥è½´å¾„ (mm) -> æŸ¥è¯¢é”®æ§½æ ‡å‡† (mm)")

    # Data: [Min_D, Max_D, Spec, W, W_tol, T2_min, T2_max, R_min, R_max]
    METRIC_DB = [
        (6, 8, "2x2", 2, 0.0125, 1.0, 1.1, 0.08, 0.16),
        (8, 10, "3x3", 3, 0.0125, 1.4, 1.5, 0.08, 0.16),
        (10, 12, "4x4", 4, 0.015, 1.8, 1.9, 0.08, 0.16),
        (12, 17, "5x5", 5, 0.015, 2.3, 2.4, 0.16, 0.25),
        (17, 22, "6x6", 6, 0.015, 2.8, 2.9, 0.16, 0.25),
        (22, 30, "8x7", 8, 0.018, 3.3, 3.5, 0.16, 0.25),
        (30, 38, "10x8", 10, 0.018, 3.3, 3.5, 0.25, 0.40),
        (38, 44, "12x8", 12, 0.0215, 3.3, 3.5, 0.25, 0.40),
        (44, 50, "14x9", 14, 0.0215, 3.8, 4.0, 0.25, 0.40),
        (50, 58, "16x10", 16, 0.0215, 4.3, 4.5, 0.25, 0.40),
        (58, 65, "18x11", 18, 0.0215, 4.4, 4.6, 0.25, 0.40),
        (65, 75, "20x12", 20, 0.026, 4.9, 5.1, 0.40, 0.60),
        (75, 85, "22x14", 22, 0.026, 5.4, 5.6, 0.40, 0.60),
        (85, 95, "25x14", 25, 0.026, 5.4, 5.6, 0.40, 0.60),
        (95, 110, "28x16", 28, 0.026, 6.4, 6.6, 0.40, 0.60)
    ]

    m_shaft = st.number_input("è¾“å…¥è½´ç›´å¾„ (mm)", 6.0, 110.0, 50.0, 1.0)
    if st.button("æŸ¥è¯¢å…¬åˆ¶é”®æ§½"):
        for row in METRIC_DB:
            if row[0] < m_shaft <= row[1]:
                st.success(f"âœ… åŒ¹é…è§„æ ¼: {row[2]} (è½´ Ã˜{m_shaft})")
                c1, c2, c3 = st.columns(3)
                c1.metric("é”®å®½ (W)", f"{row[3]} Â±{row[4]}")
                c2.metric("é”®æ·± (T2)", f"{row[5]}~{row[6]}")
                c3.metric("åœ†è§’ (R)", f"{row[7]}~{row[8]}")
                break
        else:
            st.warning("æ— åŒ¹é…æ•°æ® (æ”¯æŒ 6-110mm)")

# ==============================================================================
# TAB 3: è‹±åˆ¶é”®æ§½ (æŒ‰è½´å¾„æŸ¥è¯¢) - NEW!
# ==============================================================================
with tab3:
    st.header("è‹±åˆ¶é”®æ§½ (Imperial Keyway)")
    st.caption("è¾“å…¥è½´å¾„ (inch) -> æŸ¥è¯¢é”®æ§½å°ºå¯¸ (decimal inch)")
    st.caption("æ•°æ®æºï¼šåŸºäºä¸Šä¼ çš„ Decimal Inch è¡¨æ ¼")

    # æ•°æ®æ ¼å¼: (Shaft_Min, Shaft_Max, W_min, W_max, T2_min, T2_max, R_min, R_max)
    # æ³¨æ„: èŒƒå›´æ˜¯ Shaft > Min AND Shaft <= Max
    IMPERIAL_SHAFT_DB = [
        (0.2362, 0.3150, 0.0783, 0.0792, 0.0394, 0.0433, 0.004, 0.006),
        (0.3150, 0.3937, 0.1176, 0.1186, 0.0551, 0.0591, 0.004, 0.006),
        (0.3937, 0.4724, 0.1569, 0.1581, 0.0709, 0.0748, 0.004, 0.006),
        (0.4724, 0.6693, 0.1963, 0.1974, 0.0906, 0.0945, 0.007, 0.009),
        (0.6693, 0.8661, 0.2357, 0.2368, 0.1102, 0.1142, 0.007, 0.009),
        (0.8661, 1.1811, 0.3143, 0.3157, 0.1299, 0.1378, 0.007, 0.009),
        (1.1811, 1.4961, 0.3930, 0.3944, 0.1299, 0.1378, 0.010, 0.015),
        (1.4961, 1.7323, 0.4716, 0.4733, 0.1299, 0.1378, 0.010, 0.015),
        (1.7323, 1.9685, 0.5503, 0.5520, 0.1496, 0.1575, 0.010, 0.015),
        (1.9685, 2.2835, 0.6291, 0.6308, 0.1693, 0.1772, 0.010, 0.015),
        (2.2835, 2.5591, 0.7078, 0.7095, 0.1732, 0.1811, 0.010, 0.015),
        (2.5591, 2.9528, 0.7864, 0.7884, 0.1929, 0.2008, 0.016, 0.023),
        (2.9528, 3.3465, 0.8651, 0.8672, 0.2126, 0.2205, 0.016, 0.023),
        (3.3465, 3.7402, 0.9832, 0.9853, 0.2126, 0.2205, 0.016, 0.023),
        (3.7402, 4.3307, 1.1013, 1.1034, 0.2520, 0.2598, 0.016, 0.023)
    ]

    c_imp1, c_imp2 = st.columns([2, 1])
    with c_imp1:
        imp_shaft = st.number_input("è¾“å…¥è‹±åˆ¶è½´å¾„ (inch)", 0.2362, 4.3307, 1.000, 0.001, format="%.4f")
    with c_imp2:
        st.write("")
        st.write("")
        btn_imp = st.button("æŸ¥è¯¢è‹±åˆ¶é”®æ§½", type="primary")

    if btn_imp:
        found = False
        for row in IMPERIAL_SHAFT_DB:
            # é€»è¾‘: Min < Shaft <= Max
            if row[0] < imp_shaft <= row[1]:
                found = True
                st.divider()
                st.subheader(f"ğŸ‡ºğŸ‡¸ è½´å¾„ {imp_shaft:.4f}\" é”®æ§½å‚æ•°")
                st.caption(f"åŒ¹é…èŒƒå›´: >{row[0]} ~ â‰¤{row[1]} inch")

                k1, k2, k3 = st.columns(3)
                # æ˜¾ç¤ºæ ¼å¼ä¿ç•™4ä½å°æ•°
                k1.metric("é”®å®½ (W)", f"{row[2]:.4f} ~ {row[3]:.4f}\"")
                k2.metric("é”®æ·± (T2)", f"{row[4]:.4f} ~ {row[5]:.4f}\"")
                k3.metric("åœ†è§’ (R)", f"{row[6]:.3f} ~ {row[7]:.3f}\"")
                
                # è¾…åŠ©ï¼šæ˜¾ç¤ºå¯¹åº”çš„ mm å‚è€ƒå€¼
                st.caption(f"å‚è€ƒå…¬åˆ¶: Wâ‰ˆ{(row[2]+row[3])/2*25.4:.1f}mm | T2â‰ˆ{(row[4]+row[5])/2*25.4:.1f}mm")
                break
        
        if not found:
            st.error("âš ï¸ æœªæ‰¾åˆ°åŒ¹é…æ•°æ®ï¼Œè¯·ç¡®è®¤è½´å¾„åœ¨ 0.2362 - 4.3307 inch ä¹‹é—´")

# ==============================================================================
# TAB 4: é”®æ§½å•ä½è½¬æ¢ (Inch Fraction -> Metric)
# ==============================================================================
with tab4:
    st.header("é”®æ§½å•ä½è½¬æ¢ (Inch Fraction -> Metric)")
    st.caption("é€‰æ‹©è‹±åˆ¶åˆ†æ•°é”®å®½ -> è·å–å…¬åˆ¶å¯¹åº”å°ºå¯¸åŠå…¬å·®")

    INCH_KEY_DB = {
        "1/8\"":   [3.1750, 1.524], "3/16\"":  [4.7625, 2.235], "1/4\"":   [6.3500, 2.921],
        "5/16\"":  [7.9375, 3.607], "3/8\"":   [9.5250, 4.293], "7/16\"":  [11.1125, 5.004],
        "1/2\"":   [12.7000, 5.670], "5/8\"":   [15.8750, 7.061], "3/4\"":   [19.0500, 8.458],
        "7/8\"":   [22.2250, 9.930], "1\"":     [25.4000, 11.227], "1-1/8\"": [28.5750, 12.420]
    }

    inch_sel = st.selectbox("é€‰æ‹©è‹±åˆ¶é”®å®½", list(INCH_KEY_DB.keys()))
    if st.button("å¼€å§‹è½¬æ¢"):
        data = INCH_KEY_DB[inch_sel]
        st.success(f"è½¬æ¢ç»“æœ: {inch_sel}")
        m1, m2 = st.columns(2)
        m1.metric("å…¬åˆ¶å®½ (W)", f"{data[0]:.4f} mm", "+0.025")
        m2.metric("å…¬åˆ¶æ·± (T2)", f"{data[1]:.3f} mm", "+0.152")
