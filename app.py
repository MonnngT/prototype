import streamlit as st
import re

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(page_title="å…¨èƒ½å·¥ç¨‹æŸ¥è¯¢åŠ©æ‰‹ v2.3", page_icon="ğŸ› ï¸", layout="wide")

st.title("ğŸ› ï¸ å…¨èƒ½å·¥ç¨‹æŸ¥è¯¢åŠ©æ‰‹")
st.markdown("é›†æˆï¼š**æ™ºèƒ½é”®æ§½å…¬å·®æŸ¥è¯¢** | **ISO 286 å…¬å·®æŸ¥è¯¢**")

# åªåˆ›å»º 2 ä¸ªé€‰é¡¹å¡
tab1, tab2 = st.tabs([
    "ğŸ” é”®æ§½å…¬å·®æŸ¥è¯¢", 
    "ğŸ“ ISO 286 å…¬å·®"
])

# ==============================================================================
# å…¨å±€æ•°æ®åº“ (ä¿ç•™ç”¨äºæ™ºèƒ½æŸ¥è¯¢çš„åå°åŒ¹é…)
# ==============================================================================

# 1. å…¬åˆ¶é”®æ§½æ•°æ®
METRIC_DB = [
    (6, 8, "2x2", 2, 0.0125, 1.0, 1.1, 0.08, 0.16),
    (8, 10, "3x3", 3, 0.0125, 1.4, 1.5, 0.08, 0.16),
    (10, 12, "4x4", 4, 0.015, 1.8, 1.9, 0.08, 0.16),
    (12, 17, "5x5", 5, 0.015, 2.3, 2.4, 0.16, 0.25),
    (17, 22, "6x6", 6, 0.015, 2.8, 2.9, 0.16, 0.25),
    (22, 30, "8x7", 8, 0.018, 3.3, 3.5, 0.16, 0.25),
    (30, 38, "10x8", 10, 0.018, 3.3, 3.5, 0.25, 0.40),
    (38, 44, "12x8", 12, 0.0215, 3.3, 3.5, 0.25, 0.40),
    (44, 50, "14x9", 14, 0.0215, 3.8, 4.0, 0.25, 0.40),
    (50, 58, "16x10", 16, 0.0215, 4.3, 4.5, 0.25, 0.40),
    (58, 65, "18x11", 18, 0.0215, 4.4, 4.6, 0.25, 0.40),
    (65, 75, "20x12", 20, 0.026, 4.9, 5.1, 0.40, 0.60),
    (75, 85, "22x14", 22, 0.026, 5.4, 5.6, 0.40, 0.60),
    (85, 95, "25x14", 25, 0.026, 5.4, 5.6, 0.40, 0.60),
    (95, 110, "28x16", 28, 0.026, 6.4, 6.6, 0.40, 0.60)
]

# 2. è‹±åˆ¶é”®æ§½æ•°æ®
IMPERIAL_SHAFT_DB = [
    (0.2362, 0.3150, 0.0783, 0.0792, 0.0394, 0.0433, 0.004, 0.006),
    (0.3150, 0.3937, 0.1176, 0.1186, 0.0551, 0.0591, 0.004, 0.006),
    (0.3937, 0.4724, 0.1569, 0.1581, 0.0709, 0.0748, 0.004, 0.006),
    (0.4724, 0.6693, 0.1963, 0.1974, 0.0906, 0.0945, 0.007, 0.009),
    (0.6693, 0.8661, 0.2357, 0.2368, 0.1102, 0.1142, 0.007, 0.009),
    (0.8661, 1.1811, 0.3143, 0.3157, 0.1299, 0.1378, 0.007, 0.009),
    (1.1811, 1.4961, 0.3930, 0.3944, 0.1299, 0.1378, 0.010, 0.015),
    (1.4961, 1.7323, 0.4716, 0.4733, 0.1299, 0.1378, 0.010, 0.015),
    (1.7323, 1.9685, 0.5503, 0.5520, 0.1496, 0.1575, 0.010, 0.015),
    (1.9685, 2.2835, 0.6291, 0.6308, 0.1693, 0.1772, 0.010, 0.015),
    (2.2835, 2.5591, 0.7078, 0.7095, 0.1732, 0.1811, 0.010, 0.015),
    (2.5591, 2.9528, 0.7864, 0.7884, 0.1929, 0.2008, 0.016, 0.023),
    (2.9528, 3.3465, 0.8651, 0.8672, 0.2126, 0.2205, 0.016, 0.023),
    (3.3465, 3.7402, 0.9832, 0.9853, 0.2126, 0.2205, 0.016, 0.023),
    (3.7402, 4.3307, 1.1013, 1.1034, 0.2520, 0.2598, 0.016, 0.023)
]

# ==============================================================================
# TAB 1: é”®æ§½å…¬å·®æŸ¥è¯¢ (ä¿ç•™å®Œæ•´åŠŸèƒ½)
# ==============================================================================
with tab1:
    st.header("ğŸ” é”®æ§½å…¬å·®æŸ¥è¯¢")
    st.caption("è¾“å…¥ç¤ºä¾‹: **8JS9**, **10P9** (å…¬åˆ¶) æˆ– **0.25**, **1/4** (è‹±åˆ¶)")

    unit_mode = st.radio("é€‰æ‹©å•ä½ä½“ç³»", ["å…¬åˆ¶ (Metric)", "è‹±åˆ¶ (Imperial)"], horizontal=True)
    col_input, col_btn = st.columns([3, 1])

    # --- å…¬åˆ¶é€»è¾‘ ---
    if unit_mode == "å…¬åˆ¶ (Metric)":
        with col_input:
            user_input = st.text_input("è¾“å…¥è§„æ ¼ä»£ç  (å¦‚ 8JS9, 10P9)", value="8JS9")
        
        match = re.match(r"(\d+)(.*)", user_input.strip())
        if match:
            size_nom = int(match.group(1))
            tol_class = match.group(2).upper()
            if not tol_class: tol_class = "h9"

            st.divider()
            
            # IT9 rough lookup
            it9_lookup = {
                (0, 3): 25, (3, 6): 30, (6, 10): 36, (10, 18): 43, 
                (18, 30): 52, (30, 50): 62, (50, 80): 74
            }
            it_val = 0
            for r, val in it9_lookup.items():
                if r[0] < size_nom <= r[1]:
                    it_val = val
                    break
            
            upper, lower = 0, 0
            is_valid_tol = True
            
            if tol_class == "JS9":
                upper = it_val / 2 / 1000; lower = -it_val / 2 / 1000
            elif tol_class == "P9":
                offset = -it_val / 1000 
                if size_nom <= 3: offset = -0.006 
                elif size_nom <= 6: offset = -0.012
                elif size_nom <= 10: offset = -0.015
                elif size_nom <= 18: offset = -0.018
                elif size_nom <= 30: offset = -0.022
                else: offset = -0.026
                upper = offset; lower = offset - (it_val / 1000)
            elif tol_class == "N9":
                upper = 0; lower = -(it_val / 1000)
            elif tol_class == "H9":
                upper = it_val / 1000; lower = 0
            else:
                st.warning(f"æš‚ä¸æ”¯æŒå…¬å·® {tol_class} çš„è‡ªåŠ¨è®¡ç®—ã€‚")
                is_valid_tol = False

            c1, c2, c3 = st.columns(3)
            c1.metric(f"é”®å®½ ({size_nom} {tol_class})", f"{size_nom:.2f} mm")
            if is_valid_tol:
                c2.metric("æœ€å¤§æé™", f"{size_nom + upper:.3f} mm", f"{upper*1000:+.0f} Î¼m")
                c3.metric("æœ€å°æé™", f"{size_nom + lower:.3f} mm", f"{lower*1000:+.0f} Î¼m")
            
            st.subheader("ğŸ“ å…³è”æ ‡å‡†å°ºå¯¸ (DIN 6885)")
            found_spec = False
            for row in METRIC_DB:
                if row[3] == size_nom:
                    found_spec = True
                    with st.expander(f"åŒ¹é…è§„æ ¼: {row[2]} (é€‚ç”¨è½´å¾„ Ã˜{row[0]}-{row[1]}mm)", expanded=True):
                        kc1, kc2, kc3 = st.columns(3)
                        kc1.write(f"**é”®å®½:** {row[3]} mm")
                        kc2.write(f"**é”®é«˜:** {row[2].split('x')[1]} mm")
                        kc3.write(f"**è½®æ¯‚æ§½æ·±:** {row[5]}~{row[6]} mm")
            if not found_spec:
                st.info("æœªæ‰¾åˆ°æ ‡å‡†é”®è§„æ ¼")
    
    # --- è‹±åˆ¶é€»è¾‘ ---
    else:
        with col_input:
            user_input_imp = st.text_input("è¾“å…¥è‹±åˆ¶é”®å®½ (å¦‚ 0.25 æˆ– 1/4)", value="0.25")
        
        try:
            if "/" in user_input_imp:
                n, d = user_input_imp.split("/")
                val_imp = float(n)/float(d)
            else:
                val_imp = float(user_input_imp)
            
            val_mm = val_imp * 25.4
            
            st.divider()
            st.subheader("ğŸ‡ºğŸ‡¸ è‹±åˆ¶é”®æ§½å‚æ•°")
            
            # ANSI B17.1 Class 2 Tolerance
            tol_imp = 0.002
            tol_mm = tol_imp * 25.4
            
            ic1, ic2 = st.columns(2)
            ic1.metric("åä¹‰å°ºå¯¸ (Nominal)", f"{val_imp:.4f}\"", f"{val_mm:.3f} mm", delta_color="off")
            ic2.metric("é”®æ§½å®½æé™ (Max)", f"{(val_imp + tol_imp):.4f}\"", f"+{tol_imp}\" (+{tol_mm:.3f} mm)")

            st.markdown("---")
            st.caption(f"åŒ¹é…æ ‡å‡†æ•°æ® (Based on ANSI B17.1 for Key Width {val_imp:.4f}\")")
            
            found_imp_spec = False
            for row in IMPERIAL_SHAFT_DB:
                mid_width = (row[2] + row[3]) / 2
                if abs(val_imp - mid_width) < 0.01:
                    found_imp_spec = True
                    shaft_range_str = f"{row[0]:.4f}\" ~ {row[1]:.4f}\""
                    shaft_range_mm = f"{row[0]*25.4:.1f} ~ {row[1]*25.4:.1f} mm"
                    depth_imp_str = f"{row[4]:.4f}\" ~ {row[5]:.4f}\""
                    depth_mm_str = f"{row[4]*25.4:.2f} ~ {row[5]*25.4:.2f} mm"
                    radius_imp_str = f"{row[6]:.3f}\" ~ {row[7]:.3f}\""
                    radius_mm_str = f"{row[6]*25.4:.2f} ~ {row[7]*25.4:.2f} mm"

                    with st.container():
                        st.info(f"ğŸ“ é€‚ç”¨è½´å¾„: {shaft_range_str} ({shaft_range_mm})")
                        k1, k2 = st.columns(2)
                        k1.write(f"**é”®æ§½æ·±åº¦ (Hub Depth):**")
                        k1.code(f"{depth_imp_str}\n>> {depth_mm_str}")
                        k2.write(f"**åœ†è§’åŠå¾„ (Radius):**")
                        k2.code(f"{radius_imp_str}\n>> {radius_mm_str}")
            
            if not found_imp_spec:
                st.warning("âš ï¸ æ³¨æ„ï¼šè¾“å…¥çš„å°ºå¯¸ä¸æ˜¯æ ‡å‡†ANSIé”®å®½ï¼Œæœªæ‰¾åˆ°å…³è”çš„æ·±åº¦/è½´å¾„æ•°æ®ã€‚")

        except Exception as e:
             st.error("è¾“å…¥æ ¼å¼æœ‰è¯¯ï¼Œè¯·è¾“å…¥å°æ•°(0.25)æˆ–åˆ†æ•°(1/4)ã€‚")

# ==============================================================================
# TAB 2: ISO 286 å…¬å·®æŸ¥è¯¢
# ==============================================================================
with tab2:
    st.header("ISO 286 å…¬å·®æŸ¥è¯¢")
    st.caption("æ”¯æŒå…¬å·®å¸¦ï¼šH7, H8, F7, F8, G7, K7, P7, h7, h8, h12, h14, g8")

    RANGES_ISO = [3, 6, 10, 18, 30, 50, 80, 120, 180, 250, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3150]
    DATA_TABLE_ISO = {
        "H7": [0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063, 0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210],
        "H8": [0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097, 0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330],
        "F7": [(0.016, 0.006), (0.022, 0.010), (0.028, 0.013), (0.034, 0.016), (0.041, 0.020), (0.050, 0.025), (0.060, 0.030), (0.071, 0.036), (0.083, 0.043), (0.096, 0.050), (0.108, 0.056), (0.119, 0.062), (0.131, 0.068), (0.150, 0.080), (0.170, 0.090), (0.190, 0.100), (0.220, 0.115), (0.260, 0.135), (0.310, 0.160), (0.365, 0.190), (0.440, 0.230)],
        "F8": [(0.020, 0.006), (0.028, 0.010), (0.035, 0.013), (0.043, 0.016), (0.053, 0.020), (0.064, 0.025), (0.076, 0.030), (0.090, 0.036), (0.106, 0.043), (0.122, 0.050), (0.137, 0.056), (0.151, 0.062), (0.165, 0.068), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)],
        "G7": [(0.012, 0.002), (0.016, 0.004), (0.020, 0.005), (0.024, 0.006), (0.028, 0.007), (0.034, 0.009), (0.040, 0.010), (0.047, 0.012), (0.054, 0.014), (0.061, 0.015), (0.069, 0.017), (0.075, 0.018), (0.083, 0.020), (0.096, 0.026), (0.108, 0.028), (0.122, 0.032), (0.141, 0.036), (0.167, 0.042), (0.200, 0.050), (0.235, 0.060), (0.280, 0.070)],
        "K7": [(0.000, -0.010), (0.003, -0.009), (0.005, -0.010), (0.006, -0.012), (0.006, -0.015), (0.007, -0.018), (0.009, -0.021), (0.010, -0.025), (0.012, -0.028), (0.013, -0.033), (0.016, -0.036), (0.017, -0.040), (0.018, -0.045), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)],
        "P7": [(-0.006, -0.016), (-0.008, -0.020), (-0.009, -0.024), (-0.011, -0.029), (-0.014, -0.035), (-0.017, -0.042), (-0.021, -0.051), (-0.024, -0.059), (-0.028, -0.068), (-0.033, -0.079), (-0.036, -0.088), (-0.041, -0.098), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)],
        "h7": [0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063, 0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210],
        "h8": [0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097, 0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330],
        "h12": [0.10, 0.12, 0.15, 0.18, 0.21, 0.25, 0.30, 0.35, 0.40, 0.46, 0.52, 0.57, 0.63, 0.70, 0.80, 0.90, 1.05, 1.25, 1.50, 1.75, 2.10],
        "h14": [0.25, 0.30, 0.36, 0.43, 0.52, 0.62, 0.74, 0.87, 1.0, 1.15, 1.3, 1.4, 1.55, 1.75, 2.0, 2.3, 2.6, 3.1, 3.7, 4.4, 5.4],
        "g8": [(-0.002, -0.016), (-0.004, -0.022), (-0.005, -0.027), (-0.006, -0.033), (-0.007, -0.040), (-0.009, -0.048), (-0.010, -0.056), (-0.012, -0.066), (-0.014, -0.077), (-0.015, -0.087), (-0.017, -0.098), (-0.018, -0.107), (-0.020, -0.117), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)]
    }

    col1, col2 = st.columns([3, 1])
    with col1:
        iso_size = st.number_input("è¾“å…¥å…¬ç§°å°ºå¯¸ (mm)", 0.1, 3150.0, 50.0, 10.0)
    with col2:
        iso_code = st.selectbox("å…¬å·®å¸¦", ["H7", "H8", "F7", "F8", "G7", "K7", "P7", "h7", "h8", "h12", "h14", "g8"])

    if st.button("æŸ¥è¯¢ ISO", type="primary"):
        idx = -1
        prev = 0
        for i, r in enumerate(RANGES_ISO):
            if iso_size <= r:
                idx = i; break
            prev = r
        
        if idx != -1 and iso_code in DATA_TABLE_ISO:
            val = DATA_TABLE_ISO[iso_code][idx]
            is_empty = False
            if isinstance(val, tuple):
                if val == (0,0): is_empty = True
                u, l = val
            elif iso_code[0] == 'H': u, l = val, 0
            else: u, l = 0, -val
            
            if is_empty:
                st.error(f"âš ï¸ {iso_code} åœ¨å°ºå¯¸ {iso_size}mm å¤„æš‚æ— æ ‡å‡†æ•°æ®ã€‚")
            else:
                st.success(f"âœ… {iso_code} (Ã˜{iso_size}mm)")
                c1, c2, c3 = st.columns(3)
                c1.metric("Max", f"{iso_size+u:.3f}")
                c2.metric("Min", f"{iso_size+l:.3f}")
                c3.metric("IT", f"{(u-l)*1000:.0f} Î¼m" if (u-l)<1 else f"{(u-l):.2f} mm")
                st.info(f"åå·®: {u*1000:+.0f}/{l*1000:+.0f} Î¼m" if abs(u)<1 else f"{u:+.3f}/{l:+.3f} mm")
        else:
            st.error("æœªæ‰¾åˆ°æ•°æ®æˆ–å°ºå¯¸è¶…å‡ºèŒƒå›´")
