import streamlit as st
import pandas as pd

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(page_title="å·¥ç¨‹å…¬å·® & é”®æ§½æŸ¥è¯¢", page_icon="âš™ï¸", layout="wide")

st.title("âš™ï¸ å¤šåŠŸèƒ½å·¥ç¨‹æŸ¥è¯¢åŠ©æ‰‹")
st.caption("é›†æˆï¼šISO 286 å…¬å·® | BS 4235/ISO å…¬åˆ¶é”®æ§½ | è‹±åˆ¶é”®æ§½è½¬æ¢")

# åˆ›å»ºé€‰é¡¹å¡
tab1, tab2, tab3 = st.tabs(["ğŸ“ ISO 286 å…¬å·®", "ğŸ—ï¸ å…¬åˆ¶é”®æ§½æŸ¥è¯¢ (ISO/BS)", "ğŸ‡ºğŸ‡¸ è‹±åˆ¶é”®æ§½è½¬æ¢"])

# ==============================================================================
# TAB 1: ISO 286 å…¬å·®æŸ¥è¯¢ (åŸåŠŸèƒ½ä¿æŒä¸å˜)
# ==============================================================================
with tab1:
    st.header("ISO 286 å…¬å·®æŸ¥è¯¢ (æŸ¥è¡¨ç‰ˆ)")
    st.caption("æ•°æ®æºï¼šåŒ¹é…æ­¤å‰ä¸Šä¼ çš„æ ‡å‡†å…¬å·®è¡¨å›¾ç‰‡ (0-3150mm)")

    # ISO 286 æ•°æ®ä¸é€»è¾‘
    RANGES_ISO = [
        3, 6, 10, 18, 30, 50, 80, 120, 180, 250, 315, 400, 500, 
        630, 800, 1000, 1250, 1600, 2000, 2500, 3150
    ]
    DATA_TABLE_ISO = {
        "H7": [0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063, 0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210],
        "H8": [0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097, 0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330],
        "F7": [(0.016, 0.006), (0.022, 0.010), (0.028, 0.013), (0.034, 0.016), (0.041, 0.020), (0.050, 0.025), (0.060, 0.030), (0.071, 0.036), (0.083, 0.043), (0.096, 0.050), (0.108, 0.056), (0.119, 0.062), (0.131, 0.068), (0.150, 0.080), (0.170, 0.090), (0.190, 0.100), (0.220, 0.115), (0.260, 0.135), (0.310, 0.160), (0.365, 0.190), (0.440, 0.230)],
        "G7": [(0.012, 0.002), (0.016, 0.004), (0.020, 0.005), (0.024, 0.006), (0.028, 0.007), (0.034, 0.009), (0.040, 0.010), (0.047, 0.012), (0.054, 0.014), (0.061, 0.015), (0.069, 0.017), (0.075, 0.018), (0.083, 0.020), (0.096, 0.026), (0.108, 0.028), (0.122, 0.032), (0.141, 0.036), (0.167, 0.042), (0.200, 0.050), (0.235, 0.060), (0.280, 0.070)],
        "K7": [(0.000, -0.010), (0.003, -0.009), (0.005, -0.010), (0.006, -0.012), (0.006, -0.015), (0.007, -0.018), (0.009, -0.021), (0.010, -0.025), (0.012, -0.028), (0.013, -0.033), (0.016, -0.036), (0.017, -0.040), (0.018, -0.045), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)],
        "h7": [0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063, 0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210],
        "h8": [0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097, 0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330],
        "h12": [0.10, 0.12, 0.15, 0.18, 0.21, 0.25, 0.30, 0.35, 0.40, 0.46, 0.52, 0.57, 0.63, 0.70, 0.80, 0.90, 1.05, 1.25, 1.50, 1.75, 2.10],
        "h14": [0.25, 0.30, 0.36, 0.43, 0.52, 0.62, 0.74, 0.87, 1.0, 1.15, 1.3, 1.4, 1.55, 1.75, 2.0, 2.3, 2.6, 3.1, 3.7, 4.4, 5.4],
        "g8": [(-0.002, -0.016), (-0.004, -0.022), (-0.005, -0.027), (-0.006, -0.033), (-0.007, -0.040), (-0.009, -0.048), (-0.010, -0.056), (-0.012, -0.066), (-0.014, -0.077), (-0.015, -0.087), (-0.017, -0.098), (-0.018, -0.107), (-0.020, -0.117), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)]
    }

    def get_tolerance_iso(size, code):
        if size <= 0 or size > 3150: return None, None, "å°ºå¯¸è¶…å‡ºèŒƒå›´"
        index = -1
        range_str = ""
        prev_r = 0
        for i, r in enumerate(RANGES_ISO):
            if size <= r:
                index = i
                range_str = f"{prev_r} ~ {r}"
                break
            prev_r = r
        if index == -1 or code not in DATA_TABLE_ISO: return None, None, "æœªæ‰¾åˆ°æ•°æ®"
        
        raw = DATA_TABLE_ISO[code][index]
        if isinstance(raw, tuple): return raw[0], raw[1], range_str
        elif code.startswith('H'): return raw, 0.0, range_str
        elif code.startswith('h'): return 0.0, -raw, range_str
        return None, None, "Error"

    col_iso1, col_iso2 = st.columns([3, 1])
    with col_iso1:
        iso_size = st.number_input("è¾“å…¥å…¬ç§°å°ºå¯¸ (mm)", 0.1, 3150.0, 1000.0, 10.0, key="iso_size")
    with col_iso2:
        iso_code = st.selectbox("å…¬å·®å¸¦", ["h14", "h12", "h8", "h7", "g8", "H7", "H8", "F7", "G7", "K7"], key="iso_code")
    
    if st.button("æŸ¥è¯¢ ISO å…¬å·®", type="primary"):
        u, l, r_info = get_tolerance_iso(iso_size, iso_code)
        if isinstance(u, str):
            st.error(r_info)
        else:
            st.success(f"âœ… ç»“æœ: {iso_code} (Ã˜{iso_size} mm)")
            st.caption(f"åˆ†æ®µ: {r_info} mm")
            c1, c2, c3 = st.columns(3)
            c1.metric("æœ€å¤§æé™", f"{iso_size+u:.3f}")
            c2.metric("æœ€å°æé™", f"{iso_size+l:.3f}")
            c3.metric("å…¬å·®å¸¦å®½", f"{(u-l)*1000:.0f} Î¼m" if (u-l)<1 else f"{(u-l):.2f} mm")
            cd1, cd2 = st.columns(2)
            cd1.info(f"ä¸Šåå·®: {u*1000:+.0f} Î¼m" if abs(u)<1 else f"{u:+.3f} mm")
            cd2.info(f"ä¸‹åå·®: {l*1000:+.0f} Î¼m" if abs(l)<1 else f"{l:+.3f} mm")


# ==============================================================================
# TAB 2: å…¬åˆ¶é”®æ§½æŸ¥è¯¢ (BS 4235-1 / ISO-R773)
# ==============================================================================
with tab2:
    st.header("å…¬åˆ¶é”®æ§½æŸ¥è¯¢ (Metric Keyway)")
    st.caption("æ•°æ®æºï¼šBS 4235-1 / ISO-R773-Js9 (å›¾ç‰‡æ ¡å‡†ç‰ˆ)")
    
    # å½•å…¥å›¾ç‰‡ä¸­çš„æ•°æ®è¡¨ (æ ¼å¼: ä¸Šé™å°ºå¯¸: {æ•°æ®})
    # æ•°æ®åˆ—: [Key(WxH), W_nom, W_tol(Â±), T2_min, T2_max, R_min, R_max]
    KEY_METRIC_DB = [
        # (Min < D <= Max)
        (6, 8,   "2 x 2",   2, 0.0125, 1.0, 1.1, 0.08, 0.16),
        (8, 10,  "3 x 3",   3, 0.0125, 1.4, 1.5, 0.08, 0.16),
        (10, 12, "4 x 4",   4, 0.015,  1.8, 1.9, 0.08, 0.16),
        (12, 17, "5 x 5",   5, 0.015,  2.3, 2.4, 0.16, 0.25),
        (17, 22, "6 x 6",   6, 0.015,  2.8, 2.9, 0.16, 0.25),
        (22, 30, "8 x 7",   8, 0.018,  3.3, 3.5, 0.16, 0.25),
        (30, 38, "10 x 8",  10, 0.018, 3.3, 3.5, 0.25, 0.40),
        (38, 44, "12 x 8",  12, 0.0215, 3.3, 3.5, 0.25, 0.40),
        (44, 50, "14 x 9",  14, 0.0215, 3.8, 4.0, 0.25, 0.40),
        (50, 58, "16 x 10", 16, 0.0215, 4.3, 4.5, 0.25, 0.40),
        (58, 65, "18 x 11", 18, 0.0215, 4.4, 4.6, 0.25, 0.40),
        (65, 75, "20 x 12", 20, 0.026,  4.9, 5.1, 0.40, 0.60),
        (75, 85, "22 x 14", 22, 0.026,  5.4, 5.6, 0.40, 0.60),
        (85, 95, "25 x 14", 25, 0.026,  5.4, 5.6, 0.40, 0.60),
        (95, 110, "28 x 16", 28, 0.026, 6.4, 6.6, 0.40, 0.60),
    ]

    col_key1, col_key2 = st.columns([2, 1])
    with col_key1:
        shaft_input = st.number_input("è¾“å…¥è½´ç›´å¾„ (mm)", 6.0, 110.0, 30.0, 1.0, help="èŒƒå›´: 6 - 110 mm")
    
    with col_key2:
        st.write("")
        st.write("")
        btn_key = st.button("æŸ¥è¯¢é”®æ§½å°ºå¯¸", type="primary")

    if btn_key:
        found = False
        for row in KEY_METRIC_DB:
            d_min, d_max, spec, w, w_tol, t2_min, t2_max, r_min, r_max = row
            if d_min < shaft_input <= d_max:
                found = True
                st.divider()
                st.subheader(f"âœ… è½´å¾„ Ã˜{shaft_input} mm å¯¹åº”é”®æ§½")
                st.caption(f"åŒ¹é…èŒƒå›´: >{d_min} ~ â‰¤{d_max} mm")
                
                # ç¬¬ä¸€è¡Œï¼šä¸»è¦è§„æ ¼
                k1, k2, k3 = st.columns(3)
                k1.metric("é”®è§„æ ¼ (W x H)", spec)
                k2.metric("é”®æ§½å®½åº¦ (W)", f"{w} mm")
                k3.metric("å®½åº¦å…¬å·®", f"Â± {w_tol} mm")
                
                # ç¬¬äºŒè¡Œï¼šæ·±åº¦ä¸åœ†è§’
                st.write("---")
                kd1, kd2 = st.columns(2)
                with kd1:
                    st.info(f"**é”®æ§½æ·±åº¦ (T2)**\n\n {t2_min:.1f} ~ {t2_max:.1f} mm")
                with kd2:
                    st.warning(f"**é”®æ§½åœ†è§’ (R)**\n\n {r_min:.2f} ~ {r_max:.2f} mm")
                break
        
        if not found:
            st.error("âš ï¸ æœªæ‰¾åˆ°è¯¥å°ºå¯¸çš„æ•°æ® (ç›®å‰æ”¯æŒ 6-110mmï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–æŸ¥çœ‹åŸå›¾è¡¥å……èŒƒå›´)")


# ==============================================================================
# TAB 3: è‹±åˆ¶é”®æ§½è½¬æ¢ (Inch to Metric)
# ==============================================================================
with tab3:
    st.header("è‹±åˆ¶é”®æ§½ -> å…¬åˆ¶è½¬æ¢")
    st.caption("æ•°æ®æºï¼šè¾“å…¥è‹±åˆ¶å®½åº¦ï¼Œè·å–å…¬åˆ¶ W å’Œ T2 (å›¾ç‰‡æ ¡å‡†ç‰ˆ)")
    
    # å½•å…¥å›¾ç‰‡ä¸­çš„è‹±åˆ¶è½¬æ¢è¡¨
    # Key: Inch Fraction, Value: [Metric W, W_tol_upper, W_tol_lower, Metric T2, T2_tol_upper, T2_tol_lower]
    # Note: å›¾ç‰‡ä¸­ Tolerance Range å®½åº¦æ˜¯ +0.025/0, æ·±åº¦æ˜¯ +0.152/0 (ç»Ÿä¸€è§„å¾‹)
    INCH_KEY_DB = {
        "1/8\"":   [3.1750, 1.524],
        "3/16\"":  [4.7625, 2.235],
        "1/4\"":   [6.3500, 2.921],
        "5/16\"":  [7.9375, 3.607],
        "3/8\"":   [9.5250, 4.293],
        "7/16\"":  [11.1125, 5.004],
        "1/2\"":   [12.7000, 5.670],
        "5/8\"":   [15.8750, 7.061],
        "3/4\"":   [19.0500, 8.458],
        "7/8\"":   [22.2250, 9.930],
        "1\"":     [25.4000, 11.227],
        "1-1/8\"": [28.5750, 12.420]
    }

    col_inch1, col_inch2 = st.columns([2, 1])
    with col_inch1:
        inch_select = st.selectbox("é€‰æ‹©è‹±åˆ¶é”®æ§½å®½åº¦ (Inch Size)", list(INCH_KEY_DB.keys()))
    
    with col_inch2:
        st.write("")
        st.write("")
        btn_inch = st.button("å¼€å§‹è½¬æ¢", type="primary")

    if btn_inch:
        data = INCH_KEY_DB[inch_select]
        w_metric = data[0]
        t2_metric = data[1]
        
        # å›¾ç‰‡ä¸­çš„ç»Ÿä¸€å…¬å·®
        w_tol_str = "+0.025 / 0 mm"
        t2_tol_str = "+0.152 / 0 mm"
        
        st.divider()
        st.subheader(f"ğŸ‡ºğŸ‡¸ {inch_select} è‹±åˆ¶é”®æ§½å‚æ•°")
        
        # ç»“æœå±•ç¤º
        m1, m2 = st.columns(2)
        
        with m1:
            st.info(f"**å…¬åˆ¶å®½åº¦ (W)**")
            st.metric("æ•°å€¼", f"{w_metric:.4f} mm")
            st.caption(f"å…¬å·®: {w_tol_str}")
            st.markdown(f"**èŒƒå›´**: {w_metric:.4f} ~ {w_metric+0.025:.4f} mm")
            
        with m2:
            st.success(f"**å…¬åˆ¶æ·±åº¦ (T2)**")
            st.metric("æ•°å€¼", f"{t2_metric:.3f} mm")
            st.caption(f"å…¬å·®: {t2_tol_str}")
            st.markdown(f"**èŒƒå›´**: {t2_metric:.3f} ~ {t2_metric+0.152:.3f} mm")
