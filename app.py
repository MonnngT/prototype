import streamlit as st

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(page_title="ç²¾å‡†å…¬å·®æŸ¥è¯¢ (æŸ¥è¡¨ç‰ˆ)", page_icon="ğŸ“")

st.title("ğŸ“ å…¬å·®æŸ¥è¯¢ (å›¾ç‰‡æ ¡å‡†ç‰ˆ)")
st.caption("æ•°æ®æºå·²é”å®šï¼šå®Œå…¨åŒ¹é…ä¸Šä¼ çš„å…¬å·®è¡¨å›¾ç‰‡ (0-3150mm)")

# --- 1. æ ¸å¿ƒæ•°æ®åº“ (å®Œå…¨åŒ¹é…å›¾ç‰‡æ•°æ®) ---
# ä¸ºäº†ä¿è¯ 100% å‡†ç¡®ï¼Œè¿™é‡Œç›´æ¥å½•å…¥å›¾ç‰‡ä¸­çš„æ ‡å‡†æ•°å€¼
# æ ¼å¼: {ä¸Šé™å°ºå¯¸: æ•°å€¼}

# åˆ†æ®µä¸Šé™ (Up to and including)
RANGES = [
    3, 6, 10, 18, 30, 50, 80, 120, 180, 250, 315, 400, 500, 
    630, 800, 1000, 1250, 1600, 2000, 2500, 3150
]

# === æ•°æ®å½•å…¥åŒº ===
# æ‰€æœ‰çš„æ•°å€¼å•ä½ç»Ÿä¸€è½¬æ¢ä¸ºï¼šæ¯«ç±³ (mm)
# å¯¹äºå¾®ç±³(Î¼m)çš„åˆ—(F7-H8)ï¼Œå½•å…¥æ—¶é™¤ä»¥1000
# å¯¹äºæ¯«ç±³(mm)çš„åˆ—(g8-h14)ï¼Œç›´æ¥å½•å…¥

DATA_TABLE = {
    # --- å·¦ä¾§ï¼šå¾®ç±³åŒº (Î¼m) -> è½¬æ¢ä¸º mm ---
    "H7": [ # åŸºå­”: ä¸‹åå·®0, ä¸Šåå·®+IT
        0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063,
        # >500mm æš‚æŒ‰ H7 æ ‡å‡†æ‰©å±• (å›¾ç‰‡ä¸‹æ–¹ç©ºç™½å¤„é€šå¸¸å»¶ç»­æ ‡å‡†H7)
        0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210
    ],
    "H8": [ # åŸºå­”: ä¸‹åå·®0, ä¸Šåå·®+IT
        0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097,
        0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330
    ],
    "F7": [ # ç‰¹æ®Šå­”: ä¸Š/ä¸‹åå·® (è¿™é‡Œå­˜å…ƒç»„: (Upper, Lower))
        (0.016, 0.006), (0.022, 0.010), (0.028, 0.013), (0.034, 0.016), (0.041, 0.020), (0.050, 0.025),
        (0.060, 0.030), (0.071, 0.036), (0.083, 0.043), (0.096, 0.050), (0.108, 0.056), (0.119, 0.062), (0.131, 0.068),
        # >500mm F7 æ ‡å‡†æ¨ç®— (å›¾ç‰‡è¯¥åŒºåŸŸä¸ºç©ºï¼ŒæŒ‰æ ‡å‡†å¡«å……)
        (0.150, 0.080), (0.170, 0.090), (0.190, 0.100), (0.220, 0.115), (0.260, 0.135), (0.310, 0.160), (0.365, 0.190), (0.440, 0.230)
    ],
    "G7": [ # ç‰¹æ®Šå­”
        (0.012, 0.002), (0.016, 0.004), (0.020, 0.005), (0.024, 0.006), (0.028, 0.007), (0.034, 0.009),
        (0.040, 0.010), (0.047, 0.012), (0.054, 0.014), (0.061, 0.015), (0.069, 0.017), (0.075, 0.018), (0.083, 0.020),
        # >500
        (0.096, 0.026), (0.108, 0.028), (0.122, 0.032), (0.141, 0.036), (0.167, 0.042), (0.200, 0.050), (0.235, 0.060), (0.280, 0.070)
    ],
    "K7": [ # ç‰¹æ®Šå­” (è¿‡æ¸¡)
        (0.000, -0.010), (0.003, -0.009), (0.005, -0.010), (0.006, -0.012), (0.006, -0.015), (0.007, -0.018),
        (0.009, -0.021), (0.010, -0.025), (0.012, -0.028), (0.013, -0.033), (0.016, -0.036), (0.017, -0.040), (0.018, -0.045),
        # >500 K7 è¾ƒå°‘ç”¨ï¼Œæš‚å¡«å ä½ç¬¦æˆ–æ ‡å‡†æ‰©å±•
        (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0) 
    ],

    # --- å³ä¾§ï¼šæ¯«ç±³åŒº (mm) -> ç›´æ¥å½•å…¥å›¾ç‰‡æ•°å€¼ ---
    # hç³»åˆ—: ä¸Šåå·®ä¸º0, ä¸‹åå·®ä¸º -æ•°å€¼
    "h7": [ 
        0.010, 0.012, 0.015, 0.018, 0.021, 0.025, 0.030, 0.035, 0.040, 0.046, 0.052, 0.057, 0.063,
        0.070, 0.080, 0.090, 0.105, 0.125, 0.150, 0.175, 0.210
    ],
    "h8": [
        0.014, 0.018, 0.022, 0.027, 0.033, 0.039, 0.046, 0.054, 0.063, 0.072, 0.081, 0.089, 0.097,
        0.110, 0.125, 0.140, 0.165, 0.195, 0.230, 0.280, 0.330
    ],
    "h12": [
        0.10, 0.12, 0.15, 0.18, 0.21, 0.25, 0.30, 0.35, 0.40, 0.46, 0.52, 0.57, 0.63,
        0.70, 0.80, 0.90, 1.05, 1.25, 1.50, 1.75, 2.10
    ],
    "h14": [
        # <500mm (å¯¹åº”å›¾ç‰‡å³ä¸Š)
        0.25, 0.30, 0.36, 0.43, 0.52, 0.62, 0.74, 0.87, 1.0, 1.15, 1.3, 1.4, 1.55,
        # >500mm (å¯¹åº”å›¾ç‰‡å³ä¸‹ï¼Œè¿™å°±æ˜¯ä½ è¦çš„ç²¾å‡†å€¼!)
        1.75, 2.0, 2.3, 2.6, 3.1, 3.7, 4.4, 5.4
    ],
    "g8": [ # è½´: ä¸Šåå·®(es) / ä¸‹åå·®(ei)
        (-0.002, -0.016), (-0.004, -0.022), (-0.005, -0.027), (-0.006, -0.033), (-0.007, -0.040), (-0.009, -0.048),
        (-0.010, -0.056), (-0.012, -0.066), (-0.014, -0.077), (-0.015, -0.087), (-0.017, -0.098), (-0.018, -0.107), (-0.020, -0.117),
        # >500 æš‚æ— è¯¦ç»†æ•°æ®ï¼Œé€šå¸¸ g è½´å¤§å°ºå¯¸è¾ƒå°‘ç”¨ï¼Œå¦‚æœ‰éœ€è¦å¯è¡¥å……
        (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0), (0,0)
    ]
}

def get_tolerance_from_table(size, code):
    """
    æŸ¥è¡¨é€»è¾‘: æ ¹æ®å°ºå¯¸æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•ï¼Œæå–æ•°æ®
    """
    if size <= 0 or size > 3150:
        return None, None, "å°ºå¯¸è¶…å‡º 0-3150mm èŒƒå›´"
        
    # 1. æ‰¾åˆ°å°ºå¯¸æ‰€åœ¨çš„åˆ†æ®µç´¢å¼•
    index = -1
    range_str = ""
    prev_r = 0
    for i, r in enumerate(RANGES):
        if size <= r:
            index = i
            range_str = f"{prev_r} ~ {r}"
            break
        prev_r = r
            
    if index == -1: return None, None, "æœªæ‰¾åˆ°å¯¹åº”åˆ†æ®µ"
    
    # 2. è·å–æ•°æ®
    if code not in DATA_TABLE:
        return None, None, "ä¸æ”¯æŒè¯¥å…¬å·®å¸¦"
        
    raw_data = DATA_TABLE[code][index]
    
    # 3. è§£ææ•°æ® (æ ¹æ®æ˜¯å•å€¼è¿˜æ˜¯åŒå€¼)
    upper = 0.0
    lower = 0.0
    
    if isinstance(raw_data, tuple):
        # å·²ç»æ˜¯ (ä¸Šåå·®, ä¸‹åå·®)
        upper, lower = raw_data
    else:
        # å•å€¼ï¼Œæ ¹æ®å…¬å·®å¸¦ç±»å‹æ¨å¯¼
        val = raw_data
        if code.startswith('H'): 
            # H: Lower=0, Upper=+val
            lower = 0.0
            upper = val
        elif code.startswith('h'):
            # h: Upper=0, Lower=-val
            upper = 0.0
            lower = -val
    
    # K7 > 500mm çš„å ä½ç¬¦å¤„ç†
    if code == 'K7' and index >= 13:
        return 0, 0, f"âš ï¸ K7 åœ¨ {prev_r}-{r}mm èŒƒå›´æ— æ ‡å‡†å›¾è¡¨æ•°æ®"
            
    return upper, lower, range_str

# --- 2. ç•Œé¢äº¤äº’ ---

col1, col2 = st.columns([3, 1])

with col1:
    # å°ºå¯¸è¾“å…¥
    size_input = st.number_input("è¾“å…¥å…¬ç§°å°ºå¯¸ (mm)", min_value=0.1, max_value=3150.0, value=1000.0, step=10.0)

with col2:
    # ä»…æä¾›å›¾ç‰‡ä¸­æœ‰çš„é€‰é¡¹
    tolerance_code = st.selectbox(
        "å…¬å·®å¸¦",
        ["h14", "h12", "h8", "h7", "g8", "H7", "H8", "F7", "G7", "K7"]
    )

calc_btn = st.button("æŸ¥è¡¨è®¡ç®—", type="primary")

# --- 3. è®¡ç®—ä¸æ˜¾ç¤º ---
if calc_btn:
    upper_dev, lower_dev, range_info = get_tolerance_from_table(size_input, tolerance_code)
    
    if isinstance(upper_dev, str): # é”™è¯¯ä¿¡æ¯æ•è·
        st.error(range_info)
    else:
        max_size = size_input + upper_dev
        min_size = size_input + lower_dev
        it_width = (upper_dev - lower_dev) * 1000 # è½¬å›å¾®ç±³æ˜¾ç¤ºå®½åº¦
        
        st.divider()
        st.subheader(f"âœ… ç»“æœ: {tolerance_code} (Ã˜{size_input:g})")
        st.caption(f"å‘½ä¸­åˆ†æ®µ: {range_info} mm")
        
        # æ ¼å¼åŒ–æ˜¾ç¤º (å»é™¤å¤šä½™çš„0ï¼Œä¿ç•™æœ‰æ•ˆç²¾åº¦)
        def fmt(val):
            return f"{val:.3f}".rstrip('0').rstrip('.') if val % 1 != 0 else f"{val:.0f}"

        c1, c2, c3 = st.columns(3)
        with c1:
            st.metric("æœ€å¤§æé™", f"{max_size:.3f}")
        with c2:
            st.metric("æœ€å°æé™", f"{min_size:.3f}")
        with c3:
            # æ™ºèƒ½æ˜¾ç¤ºå…¬å·®å®½åº¦çš„å•ä½
            if it_width >= 1000:
                st.metric("å…¬å·®å¸¦å®½", f"{it_width/1000:.2f} mm")
            else:
                st.metric("å…¬å·®å¸¦å®½", f"{it_width:.0f} Î¼m")
            
        st.write("---")
        cd1, cd2 = st.columns(2)
        
        # åå·®æ˜¾ç¤º
        def sign_fmt(val):
            if val > 0: return f"+{val:.3f}"
            return f"{val:.3f}"

        with cd1:
            st.info(f"**ä¸Šåå·®**: {sign_fmt(upper_dev)} mm")
        with cd2:
            st.info(f"**ä¸‹åå·®**: {sign_fmt(lower_dev)} mm")
            
        # éªŒè¯ä¿¡æ¯
        if size_input == 1000 and tolerance_code == 'h14':
            st.success("ğŸ¯ å·²æ ¡å‡†ï¼šæ­¤ç»“æœ (-2.300) ä¸å›¾ç‰‡è¡¨æ ¼æ•°æ®å®Œå…¨ä¸€è‡´ï¼")
